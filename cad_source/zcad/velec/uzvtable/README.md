# Модуль восстановления таблиц (uzvtable)

## Назначение

Модуль предназначен для автоматического восстановления таблиц на чертеже по набору примитивов (отрезков, полилиний, однострочного и многострочного текста), выбранных пользователем.

Цель — собрать разрозненные элементы, представляющие собой части таблицы, в единую структурированную модель данных и вывести результат в табличной форме с помощью компонента `fpspreadsheet`.

## Структура модуля

Модуль состоит из 6 файлов, каждый из которых выполняет определенную функцию:

### 1. `uzvtable_data.pas` — структуры данных

**Назначение:**
- Описание всех типов данных, используемых в модуле
- Единые определения для всех остальных файлов

**Основные структуры:**
- `TUzvPrimitiveItem` — базовая структура для хранения данных о примитивах
- `TUzvTableCell` — описание ячейки таблицы (границы, текст, выравнивание)
- `TUzvTableRow`, `TUzvTableColumn` — информация о строках и столбцах
- `TUzvTableGrid` — основная структура таблицы

**Константы:**
- `MIN_CELL_WIDTH`, `MIN_CELL_HEIGHT` — минимальные размеры ячейки
- `COORDINATE_TOLERANCE` — допуск при сравнении координат
- `MAX_TABLE_ROWS`, `MAX_TABLE_COLUMNS` — максимальные размеры таблицы

### 2. `uzvtable_reader.pas` — считывание данных

**Назначение:**
- Сбор всех выделенных пользователем примитивов с чертежа
- Определение типов объектов (отрезки, полилинии, тексты)
- Преобразование геометрических данных в промежуточные структуры

**Основные функции:**
- `ReadSelectedPrimitives()` — считать все выделенные примитивы
- `IsSupportedPrimitive()` — проверить, поддерживается ли тип примитива
- `ExtractPrimitiveData()` — извлечь данные из примитива

**Поддерживаемые типы примитивов:**
- Отрезки (GDBObjLine)
- Полилинии (GDBObjPolyLine)
- Однострочный текст (GDBObjText)
- Многострочный текст (GDBObjMText)

### 3. `uzvtable_analyzer.pas` — анализ и построение таблицы

**Назначение:**
- Алгоритмы группировки примитивов по координатам
- Распознавание структуры таблицы
- Формирование готовой структуры таблицы

**Основные функции:**
- `BuildTableFromPrimitives()` — построить таблицу из примитивов
- `ExtractTableLines()` — извлечь горизонтальные и вертикальные линии
- `BuildRowsAndColumns()` — построить сетку строк и столбцов
- `AssignTextToCells()` — назначить текст в ячейки

**Алгоритм работы:**
1. Извлечение горизонтальных и вертикальных линий из примитивов
2. Группировка линий по позициям с учетом допуска
3. Построение сетки строк и столбцов
4. Создание ячеек на пересечении строк и столбцов
5. Поиск текста внутри каждой ячейки по координатам

### 4. `uzvtable_gui.pas` — визуализация (fpspreadsheet)

**Назначение:**
- Отображение результата в компоненте `fpspreadsheet`
- Поддержка базовых операций редактирования
- Экспорт таблицы в файл

**Основные компоненты:**
- `TUzvTableForm` — форма для отображения таблицы
- `TsWorkbook`, `TsWorksheet` — компоненты fpspreadsheet
- `TsWorksheetGrid` — визуальный компонент для отображения

**Функции формы:**
- Отображение таблицы в GUI
- Обновление данных таблицы
- Экспорт в XLSX формат

### 5. `uzvtable_manager.pas` — управление и взаимодействие

**Назначение:**
- Центральная логика обмена между модулями
- Управление состоянием модуля (инициализация, обновление, очистка)
- Организация потоков данных: Reader → Analyzer → GUI
- Обработка ошибок и логирование

**Основной класс:**
- `TUzvTableManager` — менеджер процесса восстановления таблицы

**Методы:**
- `ProcessTableRestoration()` — выполнить полный процесс
- `ReadPrimitivesFromDrawing()` — шаг 1: чтение
- `BuildTableStructure()` — шаг 2: построение
- `ShowTableGUI()` — шаг 3: отображение

**Статусы обработки:**
- `tsNotStarted` — обработка не начата
- `tsReading` — чтение примитивов
- `tsAnalyzing` — анализ структуры
- `tsBuilding` — построение таблицы
- `tsComplete` — обработка завершена
- `tsError` — ошибка обработки

### 6. `uzvtable_commands.pas` — команды интерфейса

**Назначение:**
- Определение пользовательских команд для GUI и системы команд CAD
- Обработка команд пользователя
- Интеграция с системой команд ZCAD

**Команды:**
- `UzvRebuildTable` — восстановить таблицу из выделенных примитивов
- `UzvUpdateSelection` — обновить выделение примитивов
- `UzvShowTable` — показать последнюю восстановленную таблицу

## Использование

### Базовый сценарий

1. Выделите на чертеже примитивы, представляющие таблицу (линии, тексты)
2. Выполните команду `UzvRebuildTable` в командной строке ZCAD
3. Модуль автоматически:
   - Проанализирует выделенные примитивы
   - Построит структуру таблицы
   - Отобразит результат в окне с использованием fpspreadsheet
4. В открывшемся окне можно:
   - Просмотреть восстановленную таблицу
   - Отредактировать содержимое ячеек
   - Экспортировать таблицу в XLSX файл

### Дополнительные команды

**Обновление выделения:**
```
UzvUpdateSelection
```
Обновляет список выделенных примитивов и пересобирает таблицу без открытия GUI.

**Показать таблицу:**
```
UzvShowTable
```
Показывает последнюю восстановленную таблицу без повторного анализа примитивов.

## Технические требования

- Код соответствует рекомендациям из файла `CLAUDE.md`
- Строгая типизация
- Читаемость и модульность
- Комментирование на русском языке
- Единообразный стиль форматирования
- Отсутствие магических чисел
- Контроль ошибок и логирование действий
- Совместимость с архитектурой ZCAD

## Зависимости

### Модули ZCAD:
- `uzcdrawings` — менеджер чертежей
- `uzeentline`, `uzeentpolyline` — примитивы линий
- `uzeenttext`, `uzeentmtext` — текстовые примитивы
- `uzegeometry`, `uzegeometrytypes` — геометрические типы
- `uzccommandsabstract`, `uzccommandsimpl` — система команд
- `uzclog` — система логирования
- `uzcinterface` — интерфейс пользователя

### Внешние библиотеки:
- `fpspreadsheet` — работа с электронными таблицами
- `fpsTypes` — типы fpspreadsheet
- `fpspreadsheetgrid` — визуальный компонент

### Стандартные модули:
- `SysUtils`, `Classes`, `Math` — базовая функциональность
- `Forms`, `Controls`, `StdCtrls`, `ExtCtrls` — GUI компоненты
- `gzctnrVectorTypes`, `gvector` — контейнеры

## Ограничения

1. Максимальный размер таблицы: 1000 строк × 100 столбцов
2. Минимальный размер ячейки: 1.0 × 1.0 единиц чертежа
3. Допуск при распознавании линий: 0.5 единиц чертежа
4. Поддерживаются только прямоугольные таблицы (без наклонных линий)
5. Текст назначается ячейке по попаданию точки вставки/центра в границы ячейки

## Возможные расширения

В дальнейшем возможно:
- Экспорт таблицы в CSV
- Экспорт таблицы как DWG-объект
- Поддержка объединенных ячеек
- Распознавание стилей и форматирования
- Поддержка наклонных таблиц
- Автоматическое распознавание без предварительного выделения

## Структура файлов

```
cad_source/zcad/velec/uzvtable/
├── README.md                 (данный файл)
├── uzvtable_data.pas        (структуры данных)
├── uzvtable_reader.pas      (чтение примитивов)
├── uzvtable_analyzer.pas    (анализ и построение)
├── uzvtable_gui.pas         (визуализация)
├── uzvtable_manager.pas     (управление)
└── uzvtable_commands.pas    (команды)
```

## Логирование

Модуль активно использует систему логирования ZCAD (`uzclog`) для отслеживания процесса работы:
- Информация о каждом этапе обработки
- Количество найденных примитивов
- Статистика построенной таблицы
- Сообщения об ошибках с кодами

## Обработка ошибок

Все ошибки обрабатываются на уровне менеджера (`TUzvTableManager`) и включают:
- Код ошибки (для программной обработки)
- Текстовое сообщение (для пользователя)
- Запись в лог файл
- Вывод сообщения в историю команд ZCAD

Коды ошибок:
- 1xxx — ошибки чтения примитивов
- 2xxx — ошибки построения таблицы
- 3xxx — ошибки отображения GUI
- 9999 — неожиданные исключения
