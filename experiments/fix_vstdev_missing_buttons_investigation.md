# Исследование проблемы отсутствия индикаторов +/- в vstDev

## Проблема

После применения PR #180, который добавил ранний выход из `vstDevGetText` для колонки 0, индикаторы разворачивания/сворачивания узлов (+/-) всё ещё отсутствуют в компоненте `vstDev`.

### Симптомы

Согласно комментариям пользователя:
1. "Первый столбец vstDev все также не содержит индикаторов разворачивания/сворачивания узлов (+/-)"
2. "Первая колонка все равно перерисовываеся"
3. На скриншоте видны горизонтальные линии дерева ("черточки"), но отсутствуют кнопки +/-
4. "+/- должны располагаться в родительской ноде"
5. "Проверь место где происходит рисование кнопок"

## Анализ существующих исправлений

### PR #180 - Исправление vstDevGetText
**Что было сделано:**
```pascal
procedure TVElectrNav.vstDevGetText(...);
begin
  // ...
  if Column = 0 then Exit;  // Ранний выход для колонки 0
  // ...
end;
```

**Логика:** Предотвращает установку текста для колонки 0, чтобы не перезаписывать индикаторы дерева.

### Проблема не решена
Несмотря на исправление в PR #180, пользователь сообщает, что индикаторы всё ещё отсутствуют.

## Дополнительные возможные причины

### 1. Обработчик vstDevPaintText

**Обнаруженная проблема:**
Обработчик `vstDevPaintText` также вызывается для всех колонок, включая колонку 0. Даже если он не изменяет явно свойства canvas для колонки 0, само вызов обработчика может привести к перерисовке текста поверх индикаторов.

**Исходный код:**
```pascal
procedure TVElectrNav.vstDevPaintText(Sender: TBaseVirtualTree;
  const TargetCanvas: TCanvas; Node: PVirtualNode; Column: TColumnIndex;
  TextType: TVSTTextType);
begin
  if (Column = 1) or (Column = 7) then
  begin
    TargetCanvas.Font.Color := clBlue;
    TargetCanvas.Font.Style := [fsUnderline];
  end;
end;
```

**Решение:**
Добавлен ранний выход для колонки 0:
```pascal
procedure TVElectrNav.vstDevPaintText(...);
begin
  // Колонка 0 зарезервирована для индикаторов дерева (+/-), не трогаем её
  if Column = 0 then Exit;

  if (Column = 1) or (Column = 7) then
    // ...
end;
```

### 2. Недостаточная ширина колонки 0

**Обнаруженная проблема:**
Колонка 0 имела ширину всего 30 пикселей. Это могло быть недостаточно для корректного отображения:
- Отступов дерева (индентация для дочерних узлов)
- Кнопок +/- (обычно 9-13 пикселей)
- Линий дерева (горизонтальных/вертикальных соединителей)

Для узлов второго уровня иерархии:
- Отступ: ~18-20 пикселей
- Кнопка: ~9-13 пикселей
- Итого: ~27-33 пикселей (не влезает в 30!)

**Исходный код:**
```pascal
with vstDev.Header.Columns.Add do
begin
  Text := '';
  Width := 30;
end;
```

**Решение:**
Увеличена ширина до 50 пикселей:
```pascal
with vstDev.Header.Columns.Add do
begin
  Text := '';
  Width := 50;  // Увеличена ширина для надежного отображения
end;
```

## Внесённые исправления

### Исправление 1: vstDevPaintText ранний выход
**Файл:** `cad_source/zcad/velec/connectmanager/gui/velectrnav.pas:543-545`

Добавлен ранний выход из `vstDevPaintText` для колонки 0, чтобы полностью избежать любой обработки этой колонки.

### Исправление 2: Увеличение ширины колонки 0
**Файл:** `cad_source/zcad/velec/connectmanager/gui/velectrnav.pas:326`

Увеличена ширина колонки 0 с 30 до 50 пикселей для гарантированного размещения индикаторов с учетом отступов.

## Техническая информация о VirtualStringTree

### Как работает отрисовка индикаторов дерева

1. **MainColumn определяет колонку для структуры дерева**
   - В нашем случае: `vstDev.Header.MainColumn := 0`
   - Эта колонка содержит отступы, линии и кнопки +/-

2. **toShowButtons контролирует видимость кнопок**
   - Должна быть включена: `toShowButtons` в `TreeOptions.PaintOptions`
   - В нашем случае: включена в строке 312

3. **toShowTreeLines контролирует видимость линий**
   - Горизонтальные и вертикальные линии, соединяющие узлы
   - В нашем случае: включена в строке 312

4. **OnGetText НЕ должен обрабатывать MainColumn**
   - Если OnGetText устанавливает CellText для MainColumn
   - Текст отрисовывается поверх индикаторов дерева
   - Решение: ранний выход для Column = 0

5. **OnPaintText НЕ должен обрабатывать MainColumn**
   - Аналогично OnGetText
   - Даже изменение свойств canvas может вызвать перерисовку
   - Решение: ранний выход для Column = 0

### Почему FDeviceTree работает, а vstDev не работал

**FDeviceTree (левая панель навигации):**
- Имеет только ОДНУ колонку
- Эта колонка одновременно:
  - MainColumn (для структуры дерева)
  - Колонка данных (для имён устройств)
- OnGetText возвращает имя устройства
- Текст появляется РЯДОМ с индикаторами дерева (не перезаписывает их)

**vstDev (правая панель с таблицей):**
- Имеет НЕСКОЛЬКО колонок (0-7)
- Колонка 0: ТОЛЬКО структура дерева (без текста данных)
- Колонки 1-7: Колонки данных
- Требуется НЕ устанавливать текст для колонки 0
- Иначе текст перезаписывает индикаторы

## Проверка исправления

Для проверки исправления:

1. Соберите проект с внесёнными изменениями
2. Откройте фрейм VElectrNav
3. Нажмите кнопку "*" (AllSelActionExecute) для загрузки устройств
4. Проверьте vstDev (правая панель):
   - ✅ Колонка 0 должна показывать индикаторы +/- для родительских узлов
   - ✅ Колонка 0 должна быть достаточно широкой (50 пикселей)
   - ✅ Горизонтальные линии дерева должны быть видны
   - ✅ Клик по +/- должен разворачивать/сворачивать дочерние узлы
   - ✅ Все колонки данных (1-7) должны отображаться корректно

## Сводка изменений

| Файл | Строка | Изменение |
|------|--------|-----------|
| velectrnav.pas | 543-545 | Добавлен ранний выход из vstDevPaintText для Column = 0 |
| velectrnav.pas | 326 | Увеличена ширина колонки 0 с 30 до 50 пикселей |

## Связанные ресурсы

- Issue #176: https://github.com/veb86/zcadvelecAI/issues/176
- PR #180: Исправление vstDevGetText (ранний выход для Column = 0)
- PR #182: Текущий PR с дополнительными исправлениями
- Документация VirtualStringTree по свойству MainColumn
- Lazarus VirtualStringTree события OnGetText и OnPaintText
